# Open Case CS2 — PHP + MySQL demo (Expanded)

Этот репозиторий — учебный демонстрационный проект open-case (механика открытия кейсов) на PHP + MySQL.
Включены:
- регистрация/вход
- баланс (симуляция пополнения)
- открытие кейсов с рандомом (серверная логика)
- админ-панель для добавления кейсов/предметов
- скрипт для создания администратора
- пример GitHub Actions для линтинга и опционального деплоя через SSH

---

## Быстрый запуск локально (подробно)

### Требования
- PHP 8.0+
- MySQL / MariaDB
- Composer (не обязателен для этой демо-версии)
- Git (для загрузки на GitHub)

### 1) Распаковать проект
```bash
unzip open-case-cs2-php-mysql.zip
cd open-case-cs2-php-mysql
```

### 2) Создать базу данных и импортировать схему
Создайте базу `open_case` (имя может быть другим):
```sql
CREATE DATABASE open_case CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```
Импортируйте схему и тестовые данные:
```bash
mysql -u root -p open_case < db/init.sql
```

### 3) Настроить конфигурацию
Скопируйте `config.sample.php` в корне как `config.php` и укажите параметры подключения к БД:
```php
<?php
return [
  'db' => [
    'host' => '127.0.0.1',
    'dbname' => 'open_case',
    'user' => 'root',
    'pass' => '',
    'charset' => 'utf8mb4',
  ],
  'site' => [
    'base_url' => 'http://localhost:8000'
  ]
];
```

### 4) Создать администратора
Есть два варианта:

1) Через CLI-скрипт:
```bash
php tools/create_admin.php admin_username admin_password
```
Этот скрипт создаст пользователя и установит `is_admin = 1`.

2) Или вручную: создайте пользователя через страницу регистрации, затем в MySQL выполните:
```sql
UPDATE users SET is_admin = 1 WHERE username = 'your_user';
```

### 5) Запустить локальный сервер
В корне проекта запустите встроенный PHP-сервер, указывая `public` как корень:
```bash
php -S 0.0.0.0:8000 -t public
```
Откройте http://localhost:8000 в браузере.

### 6) Войти / Тестирование
- Зарегистрируйтесь или используйте созданного администратора.
- Перейдите в «Кабинет», затем в `/public/admin.php` (доступ только для админа) — добавьте кейсы и предметы.
- Пополните баланс (форма в кабинете) — откройте кейс.

---

## Развёртывание на сервер (через GitHub Actions)
В репозитории есть workflow `.github/workflows/php.yml`. Он выполняет:
1. Линт PHP-файлов.
2. При пуше в `main` — опционально выполняет деплой через SSH/rsync.

Чтобы включить деплой:
1. Создайте на сервере SSH-ключ и добавьте публичный ключ в `~/.ssh/authorized_keys`.
2. В репозитории GitHub добавьте Secrets:
   - `SSH_PRIVATE_KEY` — приватный ключ (PEM)
   - `SSH_HOST` — хост или IP
   - `SSH_USER` — имя пользователя
   - `SSH_TARGET_DIR` — директория на сервере для деплоя (например `/var/www/opencase`)

После пуша в `main` Actions проверит PHP-файлы и, при наличии секретов, выполнит rsync деплой.

---

## Безопасность и примечания
- Это демонстрация. Нужен полноценный аудит безопасности перед реальным использованием.
- Для продакшена добавьте CSRF-защиту, защиту от brute-force, rate-limits, капчу, валидацию вводимых данных, HTTPS.
- Для приема платежей используйте проверенного провайдера (Stripe, CloudPayments и т.п.), не храните данные карт.
- Проверьте локальное законодательство насчет азартных игр/гемблинга.

---

## Как загрузить на GitHub
```bash
git init
git add .
git commit -m "Initial commit with admin and CI"
# создайте репозиторий на GitHub и добавьте remote
git remote add origin https://github.com/youruser/open-case-cs2-php-mysql.git
git branch -M main
git push -u origin main
```

Если хочешь, могу:
- автоматически создать репозиторий на GitHub и запушить (понадобятся твои токен/доступы),
- или подготовить коммит и сделать pull request в твой репозиторий — скажи.
